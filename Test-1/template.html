<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RRB Section Control ‚Äî Full-Length Test (100 Qs)</title>
<!-- Your CSS stays exactly the same -->
<style>
  :root{
    --brand:#2563eb;
    --danger:#b91c1c;
    --muted:#6b7280;
    --success:#16a34a;
    --warning:#d97706;
    --info:#0ea5e9;
  }
  
  body{
    font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial; 
    background:#f8fafc; 
    margin:0;
    line-height:1.5;
  }
  
  /* ... ALL YOUR EXISTING CSS STAYS THE SAME ... */
  
  @media (max-width:768px){
    .wrap{
      padding:12px;
    }
    
    .card{
      padding:16px;
    }
    
    header{
      flex-direction:column;
      align-items:flex-start;
    }
    
    .controls{
      flex-direction:column;
      align-items:stretch;
    }
    
    .nav-controls{
      flex-direction:column;
      gap:12px;
    }
    
    .nav-controls > div{
      display:flex;
      justify-content:space-between;
      width:100%;
    }
    
    .legend{
      justify-content:center;
    }
    
    .question-stats{
      flex-direction:column;
      gap:8px;
    }
  }
</style>
</head>
<body>
<form id="quizForm">
<div class="wrap">
  <!-- START CARD -->
  <div class="card" id="startCard">
    <header>
      <div>
        <h1>RRB Section Control ‚Äî Full-Length Test</h1>
        <div style="color:var(--muted);margin-top:8px;font-size:15px">
          100 Questions | Time: 80 minutes | Each question = 1 mark | ‚Äì‚Öì negative for wrong answer
        </div>
      </div>
      <div style="text-align:right">
        <div id="timer" style="display:none">80:00</div>
        <div style="font-size:13px;color:var(--muted)">Time Remaining</div>
      </div>
    </header>

    <div class="exam-info">
      <p><strong>Important Instructions:</strong></p>
      <ul style="margin:8px 0;padding-left:20px">
        <li>Enter your name and press <strong>Start Exam</strong></li>
        <li>The exam will go full-screen and the 80-minute timer will begin</li>
        <li>Do not exit full-screen or switch tabs ‚Äî violation will auto-submit</li>
        <li>Navigate using numbered buttons or Previous/Next buttons</li>
        <li>Mark questions for review using the "Mark" button</li>
      </ul>
    </div>

    <div class="intro">
      <p><label style="font-weight:600;display:block;margin-bottom:8px">Student Name<span style="color: red;"><strong>*</strong></span> </label>
      <input type="text" id="studentName" placeholder="Enter your full name" required /></p>

      <div class="controls">
        <button id="startBtn" class="success">üéØ Start Exam</button>
        <button class="secondary" id="demoBtn" type="button">üß™ Demo (No Fullscreen)</button>
      </div>
    </div>
  </div>

  <!-- QUIZ CARD -->
  <div class="card" id="quizCard" style="display:none">
    <header style="align-items:flex-start">
      <div>
        <h2 id="qHeading">Question 1</h2>
        <div style="color:var(--muted);font-size:14px" id="qCategory"></div>
      </div>
      <div style="text-align:right">
        <div id="timerTop" style="font-weight:700;color:var(--danger);font-size:20px">80:00</div>
        <div style="font-size:13px;color:var(--muted)">Time Remaining</div>
      </div>
    </header>

    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text">
        <span>Progress: <span id="answeredCount">0</span>/<span id="totalQuestions">0</span></span>
        <span>Time: <span id="timeElapsed">00:00</span></span>
      </div>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-color legend-current"></div>
        <span>Current</span>
      </div>
      <div class="legend-item">
        <div class="legend-color legend-answered"></div>
        <span>Answered</span>
      </div>
      <div class="legend-item">
        <div class="legend-color legend-marked"></div>
        <span>Marked</span>
      </div>
      <div class="legend-item">
        <div class="legend-color legend-unvisited"></div>
        <span>Unvisited</span>
      </div>
    </div>

    <div class="qbox" id="qbox"></div>
    
    <div class="nav-numbers" id="navNumbers"></div>

    <div class="nav-controls" style="display:flex;justify-content:space-between;align-items:center;margin-top:20px;padding-top:20px;border-top:1px solid #e5e7eb">
      <div style="display:flex;gap:12px">
        <button id="prevBtn" class="secondary" type="button">‚óÄ Previous</button>
        <button id="nextBtn" type="button">Next ‚ñ∂</button>
      </div>
      <div style="display:flex;gap:12px">
        <button id="markBtn" class="warning" type="button">üìå Mark</button>
        <button id="submitBtn" class="success" type="button">‚úÖ Submit Exam</button>
      </div>
    </div>

    <div class="footer">
      ‚ö†Ô∏è You must remain in full-screen mode. Switching tabs or exiting full-screen will auto-submit your exam.
    </div>
  </div>

  <!-- RESULT CARD -->
  <div class="card" id="resultCard" style="display:none">
    <h2>üìä Exam Submitted</h2>
    <div id="resultSummary" class="result"></div>
    <div class="summary" id="detailSummary"></div>
  </div>
</div>
</form>

<!-- FIXED: Load questions.js FIRST, then your main script -->
<script src="questions.js"></script>
<script>
// STATE
let currentIndex = 0;
let responses = [];
let markedQuestions = [];
let studentName = "";
let timerSec = 80 * 60;
let timerInterval = null;
let examStarted = false;
let startTime = null;

const startCard = document.getElementById('startCard'),
      quizCard = document.getElementById('quizCard'),
      resultCard = document.getElementById('resultCard'),
      qHeading = document.getElementById('qHeading'),
      qCategory = document.getElementById('qCategory'),
      qbox = document.getElementById('qbox'),
      navNumbers = document.getElementById('navNumbers'),
      timerTop = document.getElementById('timerTop'),
      timerMain = document.getElementById('timer'),
      progressFill = document.getElementById('progressFill'),
      answeredCountEl = document.getElementById('answeredCount'),
      totalQuestionsEl = document.getElementById('totalQuestions'),
      timeElapsedEl = document.getElementById('timeElapsed'),
      markBtn = document.getElementById('markBtn');

// Initialize arrays based on external quiz data
function initializeArrays() {
  responses = new Array(quiz.length).fill(null);
  markedQuestions = new Array(quiz.length).fill(false);
}

function escapeHtml(str) {
  return String(str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
}

function updateProgress() {
  const answered = responses.filter(r => r !== null).length;
  const progress = (answered / quiz.length) * 100;
  progressFill.style.width = `${progress}%`;
  answeredCountEl.textContent = answered;
  totalQuestionsEl.textContent = quiz.length;
  
  // Update time elapsed
  if (startTime) {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    timeElapsedEl.textContent = formatTime(elapsed);
  }
}

function buildNav() {
  navNumbers.innerHTML = '';
  quiz.forEach((_, i) => {
    const btn = document.createElement('button');
    btn.type = "button";
    btn.textContent = i + 1;
    btn.dataset.idx = i;
    btn.onclick = () => {
      saveCurrent();
      currentIndex = i;
      renderQuestion();
    };
    navNumbers.appendChild(btn);
  });
}

function renderQuestion() {
  const item = quiz[currentIndex];
  qHeading.textContent = `Question ${currentIndex + 1}`;
  qCategory.textContent = item.cat;
  
  let html = `<div class="qtext">${item.q}</div>`;
  item.opts.forEach((opt, i) => {
    const checked = (responses[currentIndex] === opt) ? 'checked' : '';
    html += `<label class="opt"><input type="radio" name="opt" value="${escapeHtml(opt)}" ${checked}/> ${String.fromCharCode(65 + i)}. ${opt}</label>`;
  });
  qbox.innerHTML = html;
  
  // Update navigation buttons
  Array.from(navNumbers.children).forEach((b, idx) => {
    b.classList.remove('current', 'answered', 'marked');
    
    if (idx === currentIndex) {
      b.classList.add('current');
    } else if (markedQuestions[idx]) {
      b.classList.add('marked');
    } else if (responses[idx] !== null) {
      b.classList.add('answered');
    }
    
    // Handle combined states
    if (markedQuestions[idx] && responses[idx] !== null) {
      b.classList.add('answered', 'marked');
    }
  });
  
  // Update mark button
  markBtn.textContent = markedQuestions[currentIndex] ? "‚ùå Unmark" : "üìå Mark";
  markBtn.className = markedQuestions[currentIndex] ? "secondary" : "warning";
  
  updateProgress();
}

function saveCurrent() {
  const sel = qbox.querySelector('input[name="opt"]:checked');
  if (sel) {
    responses[currentIndex] = sel.value;
  }
}

function formatTime(s) {
  const m = Math.floor(s / 60);
  const sec = s % 60;
  return `${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
}

function startExam() {
  const nameInput = document.getElementById('studentName').value.trim();
  if (!nameInput) {
    alert('Please enter your name to start the exam.');
    document.getElementById('studentName').focus();
    return;
  }
  studentName = nameInput;
  openFullscreen();
  startCore();
}

function startDemo() {
  studentName = document.getElementById('studentName').value.trim() || 'Demo Student';
  startCore(true);
}

function startCore(demo = false) {
  examStarted = true;
  startTime = Date.now();
  startCard.style.display = 'none';
  quizCard.style.display = 'block';
  timerMain.style.display = demo ? 'none' : 'block';
  
  // Initialize arrays first
  initializeArrays();
  
  // Initialize progress
  totalQuestionsEl.textContent = quiz.length;
  updateProgress();
  
  buildNav();
  renderQuestion();
  
  timerInterval = setInterval(() => {
    timerSec--;
    timerTop.textContent = formatTime(timerSec);
    timerMain.textContent = formatTime(timerSec);
    updateProgress();
    
    if (timerSec <= 0) {
      clearInterval(timerInterval);
      alert('Time is up! Your exam will be submitted automatically.');
      finishExam();
    }
  }, 1000);
}

function openFullscreen() {
  const el = document.documentElement;
  if (el.requestFullscreen) el.requestFullscreen();
  else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
  else if (el.msRequestFullscreen) el.msRequestFullscreen();
}

function closeFullscreen() {
  if (document.exitFullscreen) document.exitFullscreen();
  else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
  else if (document.msExitFullscreen) document.msExitFullscreen();
}

// Tab and fullscreen monitoring
document.addEventListener('visibilitychange', () => {
  if (examStarted && document.hidden) {
    alert('Tab switch detected. Your exam will be auto-submitted.');
    finishExam();
  }
});

document.addEventListener('fullscreenchange', () => {
  if (examStarted && !document.fullscreenElement) {
    alert('Fullscreen exited. Your exam will be auto-submitted.');
    finishExam();
  }
});

// Event Listeners
document.getElementById('startBtn').addEventListener('click', e => {
  e.preventDefault();
  startExam();
});

document.getElementById('demoBtn').addEventListener('click', e => {
  e.preventDefault();
  startDemo();
});

document.getElementById('prevBtn').addEventListener('click', () => {
  saveCurrent();
  if (currentIndex > 0) {
    currentIndex--;
    renderQuestion();
  }
});

document.getElementById('nextBtn').addEventListener('click', () => {
  saveCurrent();
  if (currentIndex < quiz.length - 1) {
    currentIndex++;
    renderQuestion();
  }
});

document.getElementById('markBtn').addEventListener('click', () => {
  markedQuestions[currentIndex] = !markedQuestions[currentIndex];
  renderQuestion();
});

document.getElementById('submitBtn').addEventListener('click', () => {
  if (confirm('Are you sure you want to submit your exam? You cannot return after submission.')) {
    finishExam();
  }
});

function finishExam() {
  if (!examStarted) return;
  examStarted = false;
  clearInterval(timerInterval);
  saveCurrent();

  let score = 0;
  let max = 0;
  const details = [];
  let correctCount = 0;
  let incorrectCount = 0;
  let unattemptedCount = 0;

  quiz.forEach((it, i) => {
    max += it.marks;
    let got = 0;

    if (responses[i]) {
      if (responses[i] === it.ans) {
        got = it.marks;
        correctCount++;
      } else {
        got = -(it.marks / 3);
        incorrectCount++;
      }
    } else {
      unattemptedCount++;
    }

    score += got;
    details.push({
      q: it.q,
      given: responses[i] || '(no answer)',
      correct: it.ans,
      marks: got,
      category: it.cat
    });
  });

  const displayScore = Math.round((score + Number.EPSILON) * 100) / 100;
  const percentage = Math.round((displayScore / max) * 100);

  quizCard.style.display = 'none';
  resultCard.style.display = 'block';
  
  document.getElementById('resultSummary').innerHTML = `
    <div style="background:#f0f9ff;padding:20px;border-radius:8px;border-left:4px solid var(--brand);">
      <h3 style="margin-top:0;">Exam Results</h3>
      <p><strong>Name:</strong> ${escapeHtml(studentName)}</p>
      <p><strong>Final Score:</strong> <span style="font-size:24px;font-weight:bold;color:var(--brand)">${displayScore}/${max}</span> (${percentage}%)</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:12px;margin-top:12px;">
        <div style="text-align:center;padding:12px;background:#dcfce7;border-radius:6px;">
          <div style="font-size:24px;font-weight:bold;color:var(--success)">${correctCount}</div>
          <div>Correct</div>
        </div>
        <div style="text-align:center;padding:12px;background:#fef2f2;border-radius:6px;">
          <div style="font-size:24px;font-weight:bold;color:var(--danger)">${incorrectCount}</div>
          <div>Incorrect</div>
        </div>
        <div style="text-align:center;padding:12px;background:#f3f4f6;border-radius:6px;">
          <div style="font-size:24px;font-weight:bold;color:var(--muted)">${unattemptedCount}</div>
          <div>Unattempted</div>
        </div>
      </div>
    </div>
  `;

  const d = document.getElementById('detailSummary');
  d.innerHTML = '<h3>Detailed Analysis</h3>';
  
  // Group by category
  const categories = {};
  details.forEach((r, i) => {
    if (!categories[r.category]) {
      categories[r.category] = [];
    }
    categories[r.category].push({...r, index: i});
  });
  
  // Create summary by category
  for (const [category, questions] of Object.entries(categories)) {
    const categoryDiv = document.createElement('div');
    categoryDiv.className = 'result-item';
    categoryDiv.innerHTML = `<h4>${category}</h4>`;
    d.appendChild(categoryDiv);
    
    questions.forEach(r => {
      const el = document.createElement('div');
      el.style.marginBottom = '16px';
      el.style.padding = '12px';
      el.style.borderRadius = '6px';
      el.style.background = r.marks > 0 ? '#f0fdf4' : r.marks < 0 ? '#fef2f2' : '#f8fafc';
      el.style.borderLeft = `4px solid ${r.marks > 0 ? '#22c55e' : r.marks < 0 ? '#ef4444' : '#64748b'}`;
      
      let answerClass = 'unattempted';
      if (r.given !== '(no answer)') {
        answerClass = r.given === r.correct ? 'correct' : 'incorrect';
      }
      
      el.innerHTML = `
        <div><strong>Q${r.index + 1}:</strong> ${r.q}</div>
        <div style="margin-top:8px;">
          <span>Your Answer: <span class="${answerClass}">${escapeHtml(String(r.given))}</span></span> | 
          <span>Correct: <span class="correct">${escapeHtml(String(r.correct))}</span></span> | 
          <span>Marks: <strong>${r.marks}</strong></span>
        </div>
      `;
      d.appendChild(el);
    });
  }

  // Send result to Google Script
  fetch("https://script.google.com/macros/s/AKfycbym7870t9FYTGPZqgXjxzS2WdL4ye4uqfudkpfVQHAAJUUKn6DPt6RQRCIvlyHfJmSk/exec", {
    method: "POST",
    body: new URLSearchParams({
      name: studentName,
      score: displayScore,
      total: max,
      percentage: percentage,
      correct: correctCount,
      incorrect: incorrectCount,
      unattempted: unattemptedCount,
      answers: JSON.stringify(details)
    })
  })
  .then(() => console.log("Result sent successfully"))
  .catch(err => console.error("Error sending result:", err));

  try {
    closeFullscreen();
  } catch (e) {
    console.log("Fullscreen exit failed:", e);
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  // Focus on name input
  document.getElementById('studentName').focus();
});
</script>
</body>
</html>
